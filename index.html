<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>アンケート共有アプリ</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <!-- Chart.js（グラフ用） -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- xlsx.js（Excel読み込み用） -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
 <style>
    body { 
      font-family: sans-serif; 
      margin: 2em; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    #chart-container { width: 600px; height: 400px; }
    .btn { padding: 0.5em 1em; margin: 0.5em; }
  </style>
</head>
<body>
  <h1>アンケート共有アプリ</h1>
  <input type="file" id="file-upload" accept=".xlsx,.xls" class="btn">
  <button id="reset-btn" class="btn">データリセット</button>
  <div id="status"></div>
  <div id="chart-container">
    <canvas id="result-chart"></canvas>
  </div>
  <script>
    // Firebase設定
    const firebaseConfig = {
      apiKey: "AIzaSyA5iITOYcaJ5qwl8tlOgvMOstpIqYgPeYs",
      authDomain: "questionnaire-4306a.firebaseapp.com",
      databaseURL: "https://questionnaire-4306a-default-rtdb.firebaseio.com",
      projectId: "questionnaire-4306a",
      storageBucket: "questionnaire-4306a.firebasestorage.app",
      messagingSenderId: "818511321932",
      appId: "1:818511321932:web:e96e26a66e4b1bd7534de9",
      measurementId: "G-44DRTCMCC1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // データ保存
    function saveSurveyData(data) {
      db.ref('survey-data').set(data);
    }
    // データ取得
    function loadSurveyData(callback) {
      db.ref('survey-data').once('value').then(snapshot => {
        callback(snapshot.val());
      });
    }
    // データリセット
    function resetSurveyData() {
      db.ref('survey-data').remove();
    }

    // グラフ描画
    let chart;
    function renderChart(labels, counts) {
      const ctx = document.getElementById('result-chart').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: '回答数',
            data: counts,
            backgroundColor: 'rgba(54, 162, 235, 0.5)'
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    // UI描画
    function renderUI() {
      loadSurveyData(function(data) {
        const status = document.getElementById('status');
        if (!data) {
          status.textContent = 'データがありません。Excelファイルをアップロードしてください。';
          renderChart([], []);
          return;
        }
        status.textContent = '現在の集計結果:';
        // 例: data = { "A": 5, "B": 3, "C": 2 }
        const labels = Object.keys(data);
        const counts = Object.values(data);
        renderChart(labels, counts);
      });
    }

    // Excelファイルアップロード
    document.getElementById('file-upload').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data);
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
      // 1列目の値を集計
      const counts = {};
      for (let i = 1; i < json.length; i++) {
        const val = json[i][0];
        if (!val) continue;
        counts[val] = (counts[val] || 0) + 1;
      }
      saveSurveyData(counts);
      alert('アップロード完了！全員が結果を見られるようになりました');
      renderUI();
    };

    // データリセット
    document.getElementById('reset-btn').onclick = () => {
      if (confirm('本当にデータをリセットしますか？全員のデータが削除されます。')) {
        resetSurveyData();
        alert('データをリセットしました');
        renderUI();
      }
    };

    // 初期表示
    renderUI();

    // 他の人の変更もリアルタイム反映
    db.ref('survey-data').on('value', () => renderUI());
  </script>
</body>
</html>

