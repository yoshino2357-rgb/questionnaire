<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>アンケート集計</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>

<body class="min-h-screen bg-gray-100 p-6">
  <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-xl p-6">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">アンケート集計ツール</h1>

    <!-- Upload -->
    <div class="mb-6">
      <input type="file" id="fileInput" accept=".xlsx,.xls"
        class="block w-full border p-2 rounded" />
    </div>

    <!-- Loading -->
    <div id="loading" class="text-center text-gray-500 hidden">読み込み中...</div>

    <!-- Charts -->
    <div id="charts" class="grid md:grid-cols-2 gap-6"></div>
  </div>

<script>
const COLORS = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4','#84cc16'];

let surveyData = null;

// 初期ロード
window.onload = () => {
  const saved = localStorage.getItem('survey-data');
  if (saved) {
    surveyData = JSON.parse(saved);
    renderCharts();
  }
};

// ファイルアップロード
document.getElementById("fileInput").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  document.getElementById("loading").classList.remove("hidden");

  const buffer = await file.arrayBuffer();
  const workbook = XLSX.read(buffer);
  const sheet = workbook.Sheets[workbook.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sheet);

  surveyData = aggregate(rows);
  localStorage.setItem("survey-data", JSON.stringify(surveyData));

  renderCharts();
  document.getElementById("loading").classList.add("hidden");
});

// 集計処理
function aggregate(rows) {
  const result = {};

  rows.forEach(row => {
    Object.keys(row).forEach(key => {
      if (!result[key]) result[key] = {};
      const value = row[key];
      result[key][value] = (result[key][value] || 0) + 1;
    });
  });

  return result;
}

// グラフ描画
function renderCharts() {
  const container = document.getElementById("charts");
  container.innerHTML = "";

  Object.entries(surveyData).forEach(([question, answers], index) => {
    const canvasId = "chart" + index;

    container.innerHTML += `
      <div class="bg-gray-50 rounded-xl p-4">
        <h2 class="font-bold mb-2">${question}</h2>
        <canvas id="${canvasId}"></canvas>
      </div>
    `;

    const labels = Object.keys(answers);
    const data = Object.values(answers);

    new Chart(document.getElementById(canvasId), {
      type: 'pie',
      data: {
        labels,
        datasets: [{
          data,
          backgroundColor: COLORS
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  });
}
</script>
</body>
</html>
